import{Fragment as Q,computed as x,defineComponent as F,h as q,inject as X,nextTick as L,onMounted as $,onUnmounted as Y,provide as Z,ref as w,toRaw as v,watch as J,watchEffect as U}from"vue";import{Features as K,render as j,omit as W,compact as z}from'../../utils/render.js';import{useId as N}from'../../hooks/use-id.js';import{Keys as V}from'../../keyboard.js';import{calculateActiveIndex as ee,Focus as g}from'../../utils/calculate-active-index.js';import{dom as h}from'../../utils/dom.js';import{useOpenClosed as te,State as _,useOpenClosedProvider as oe}from'../../internal/open-closed.js';import{match as k}from'../../utils/match.js';import{useResolveButtonType as ne}from'../../hooks/use-resolve-button-type.js';import{useTreeWalker as ae}from'../../hooks/use-tree-walker.js';import{sortByDomNode as le}from'../../utils/focus-management.js';import{useOutsideClick as ie}from'../../hooks/use-outside-click.js';import{Hidden as ue,Features as re}from'../../internal/hidden.js';import{objectToFormEntries as de}from'../../utils/form.js';import{useControllable as se}from'../../hooks/use-controllable.js';import{useTrackedPointer as pe}from'../../hooks/use-tracked-pointer.js';function fe(n,O){return n===O}var be=(r=>(r[r.Open=0]="Open",r[r.Closed=1]="Closed",r))(be||{}),ve=(r=>(r[r.Single=0]="Single",r[r.Multi=1]="Multi",r))(ve||{}),ce=(r=>(r[r.Pointer=0]="Pointer",r[r.Other=1]="Other",r))(ce||{});let G=Symbol("ComboboxContext");function B(n){let O=X(G,null);if(O===null){let r=new Error(`<${n} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(r,B),r}return O}let je=F({name:"Combobox",emits:{"update:modelValue":n=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>fe},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},name:{type:String},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(n,{slots:O,attrs:r,emit:T}){let e=w(1),t=w(null),s=w(null),R=w(null),d=w(null),b=w({static:!1,hold:!1}),m=w([]),C=w(null),S=w(1),y=w(!1);function M(a=l=>l){let l=C.value!==null?m.value[C.value]:null,u=le(a(m.value.slice()),f=>h(f.dataRef.domRef)),i=l?u.indexOf(l):null;return i===-1&&(i=null),{options:u,activeOptionIndex:i}}let D=x(()=>n.multiple?1:0),o=x(()=>n.nullable),[c,I]=se(x(()=>n.modelValue===void 0?k(D.value,{[1]:[],[0]:void 0}):n.modelValue),a=>T("update:modelValue",a),x(()=>n.defaultValue)),p={comboboxState:e,value:c,mode:D,compare(a,l){if(typeof n.by=="string"){let u=n.by;return(a==null?void 0:a[u])===(l==null?void 0:l[u])}return n.by(a,l)},defaultValue:x(()=>n.defaultValue),nullable:o,inputRef:s,labelRef:t,buttonRef:R,optionsRef:d,disabled:x(()=>n.disabled),options:m,change(a){I(a)},activeOptionIndex:x(()=>{if(y.value&&C.value===null&&m.value.length>0){let a=m.value.findIndex(l=>!l.dataRef.disabled);if(a!==-1)return a}return C.value}),activationTrigger:S,optionsPropsRef:b,closeCombobox(){y.value=!1,!n.disabled&&e.value!==1&&(e.value=1,C.value=null)},openCombobox(){if(y.value=!0,n.disabled||e.value===0)return;let a=m.value.findIndex(l=>{let u=v(l.dataRef.value);return k(D.value,{[0]:()=>p.compare(v(p.value.value),v(u)),[1]:()=>v(p.value.value).some(f=>p.compare(v(f),v(u)))})});a!==-1&&(C.value=a),e.value=0},goToOption(a,l,u){if(y.value=!1,n.disabled||d.value&&!b.value.static&&e.value===1)return;let i=M();if(i.activeOptionIndex===null){let P=i.options.findIndex(H=>!H.dataRef.disabled);P!==-1&&(i.activeOptionIndex=P)}let f=ee(a===g.Specific?{focus:g.Specific,id:l}:{focus:a},{resolveItems:()=>i.options,resolveActiveIndex:()=>i.activeOptionIndex,resolveId:P=>P.id,resolveDisabled:P=>P.dataRef.disabled});C.value=f,S.value=u!=null?u:1,m.value=i.options},selectOption(a){let l=m.value.find(i=>i.id===a);if(!l)return;let{dataRef:u}=l;I(k(D.value,{[0]:()=>u.value,[1]:()=>{let i=v(p.value.value).slice(),f=v(u.value),P=i.findIndex(H=>p.compare(f,v(H)));return P===-1?i.push(f):i.splice(P,1),i}}))},selectActiveOption(){if(p.activeOptionIndex.value===null)return;let{dataRef:a,id:l}=m.value[p.activeOptionIndex.value];I(k(D.value,{[0]:()=>a.value,[1]:()=>{let u=v(p.value.value).slice(),i=v(a.value),f=u.findIndex(P=>p.compare(i,v(P)));return f===-1?u.push(i):u.splice(f,1),u}})),p.goToOption(g.Specific,l)},registerOption(a,l){let u={id:a,dataRef:l},i=M(f=>[...f,u]);if(C.value===null){let f=l.value.value;k(D.value,{[0]:()=>p.compare(v(p.value.value),v(f)),[1]:()=>v(p.value.value).some(H=>p.compare(v(H),v(f)))})&&(i.activeOptionIndex=i.options.indexOf(u))}m.value=i.options,C.value=i.activeOptionIndex,S.value=1},unregisterOption(a){let l=M(u=>{let i=u.findIndex(f=>f.id===a);return i!==-1&&u.splice(i,1),u});m.value=l.options,C.value=l.activeOptionIndex,S.value=1}};ie([s,R,d],()=>p.closeCombobox(),x(()=>e.value===0)),Z(G,p),oe(x(()=>k(e.value,{[0]:_.Open,[1]:_.Closed})));let E=x(()=>p.activeOptionIndex.value===null?null:m.value[p.activeOptionIndex.value].dataRef.value),A=x(()=>{var a;return(a=h(s))==null?void 0:a.closest("form")});return $(()=>{J([A],()=>{if(!A.value||n.defaultValue===void 0)return;function a(){p.change(n.defaultValue)}return A.value.addEventListener("reset",a),()=>{var l;(l=A.value)==null||l.removeEventListener("reset",a)}},{immediate:!0})}),()=>{let{name:a,disabled:l,...u}=n,i={open:e.value===0,disabled:l,activeIndex:p.activeOptionIndex.value,activeOption:E.value,value:c.value};return q(Q,[...a!=null&&c.value!=null?de({[a]:c.value}).map(([f,P])=>q(ue,z({features:re.Hidden,key:f,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:f,value:P}))):[],j({theirProps:{...r,...W(u,["modelValue","defaultValue","nullable","multiple","onUpdate:modelValue","by"])},ourProps:{},slot:i,slots:O,attrs:r,name:"Combobox"})])}}}),Be=F({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"},id:{type:String,default:()=>`headlessui-combobox-label-${N()}`}},setup(n,{attrs:O,slots:r}){let T=B("ComboboxLabel");function e(){var t;(t=h(T.inputRef))==null||t.focus({preventScroll:!0})}return()=>{let t={open:T.comboboxState.value===0,disabled:T.disabled.value},{id:s,...R}=n,d={id:s,ref:T.labelRef,onClick:e};return j({ourProps:d,theirProps:R,slot:t,attrs:O,slots:r,name:"ComboboxLabel"})}}}),He=F({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"},id:{type:String,default:()=>`headlessui-combobox-button-${N()}`}},setup(n,{attrs:O,slots:r,expose:T}){let e=B("ComboboxButton");T({el:e.buttonRef,$el:e.buttonRef});function t(d){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(d.preventDefault(),e.openCombobox()),L(()=>{var b;return(b=h(e.inputRef))==null?void 0:b.focus({preventScroll:!0})}))}function s(d){switch(d.key){case V.ArrowDown:d.preventDefault(),d.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),L(()=>{var b;return(b=e.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return;case V.ArrowUp:d.preventDefault(),d.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),L(()=>{e.value.value||e.goToOption(g.Last)})),L(()=>{var b;return(b=e.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return;case V.Escape:if(e.comboboxState.value!==0)return;d.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&d.stopPropagation(),e.closeCombobox(),L(()=>{var b;return(b=e.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return}}let R=ne(x(()=>({as:n.as,type:O.type})),e.buttonRef);return()=>{var S,y;let d={open:e.comboboxState.value===0,disabled:e.disabled.value,value:e.value.value},{id:b,...m}=n,C={ref:e.buttonRef,id:b,type:R.value,tabindex:"-1","aria-haspopup":"listbox","aria-controls":(S=h(e.optionsRef))==null?void 0:S.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(y=h(e.labelRef))==null?void 0:y.id,b].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:s,onClick:t};return j({ourProps:C,theirProps:m,slot:d,attrs:O,slots:r,name:"ComboboxButton"})}}}),Ne=F({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function},defaultValue:{type:String,default:void 0},id:{type:String,default:()=>`headlessui-combobox-input-${N()}`}},emits:{change:n=>!0},setup(n,{emit:O,attrs:r,slots:T,expose:e}){let t=B("ComboboxInput"),s={value:!1};e({el:t.inputRef,$el:t.inputRef});let R=x(()=>{var c;let o=t.value.value;return h(t.inputRef)?typeof n.displayValue!="undefined"&&o!==void 0?(c=n.displayValue(o))!=null?c:"":typeof o=="string"?o:"":""});$(()=>{J([R,t.comboboxState],([o,c],[I,p])=>{if(s.value)return;let E=h(t.inputRef);!E||(p===0&&c===1||o!==I)&&(E.value=o)},{immediate:!0})});let d=w(!1);function b(){d.value=!0}function m(){setTimeout(()=>{d.value=!1})}function C(o){switch(s.value=!0,o.key){case V.Backspace:case V.Delete:if(t.mode.value!==0||!t.nullable.value)return;let c=o.currentTarget;requestAnimationFrame(()=>{if(c.value===""){t.change(null);let I=h(t.optionsRef);I&&(I.scrollTop=0),t.goToOption(g.Nothing)}});break;case V.Enter:if(s.value=!1,t.comboboxState.value!==0||d.value)return;if(o.preventDefault(),o.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case V.ArrowDown:return s.value=!1,o.preventDefault(),o.stopPropagation(),k(t.comboboxState.value,{[0]:()=>t.goToOption(g.Next),[1]:()=>t.openCombobox()});case V.ArrowUp:return s.value=!1,o.preventDefault(),o.stopPropagation(),k(t.comboboxState.value,{[0]:()=>t.goToOption(g.Previous),[1]:()=>{t.openCombobox(),L(()=>{t.value.value||t.goToOption(g.Last)})}});case V.Home:if(o.shiftKey)break;return s.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(g.First);case V.PageUp:return s.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(g.First);case V.End:if(o.shiftKey)break;return s.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(g.Last);case V.PageDown:return s.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(g.Last);case V.Escape:if(s.value=!1,t.comboboxState.value!==0)return;o.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&o.stopPropagation(),t.closeCombobox();break;case V.Tab:if(s.value=!1,t.comboboxState.value!==0)return;t.mode.value===0&&t.selectActiveOption(),t.closeCombobox();break}}function S(o){O("change",o)}function y(o){t.openCombobox(),O("change",o)}function M(){s.value=!1}let D=x(()=>{var o,c,I,p;return(p=(I=(c=n.defaultValue)!=null?c:t.defaultValue.value!==void 0?(o=n.displayValue)==null?void 0:o.call(n,t.defaultValue.value):null)!=null?I:t.defaultValue.value)!=null?p:""});return()=>{var A,a,l,u,i,f;let o={open:t.comboboxState.value===0},{id:c,displayValue:I,...p}=n,E={"aria-controls":(A=t.optionsRef.value)==null?void 0:A.id,"aria-expanded":t.disabled.value?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(a=t.options.value[t.activeOptionIndex.value])==null?void 0:a.id,"aria-multiselectable":t.mode.value===1?!0:void 0,"aria-labelledby":(i=(l=h(t.labelRef))==null?void 0:l.id)!=null?i:(u=h(t.buttonRef))==null?void 0:u.id,id:c,onCompositionstart:b,onCompositionend:m,onKeydown:C,onChange:S,onInput:y,onBlur:M,role:"combobox",type:(f=r.type)!=null?f:"text",tabIndex:0,ref:t.inputRef,defaultValue:D.value};return j({ourProps:E,theirProps:p,slot:o,attrs:r,slots:T,features:K.RenderStrategy|K.Static,name:"ComboboxInput"})}}}),Ke=F({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(n,{attrs:O,slots:r,expose:T}){let e=B("ComboboxOptions"),t=`headlessui-combobox-options-${N()}`;T({el:e.optionsRef,$el:e.optionsRef}),U(()=>{e.optionsPropsRef.value.static=n.static}),U(()=>{e.optionsPropsRef.value.hold=n.hold});let s=te(),R=x(()=>s!==null?s.value===_.Open:e.comboboxState.value===0);return ae({container:x(()=>h(e.optionsRef)),enabled:x(()=>e.comboboxState.value===0),accept(d){return d.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:d.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(d){d.setAttribute("role","none")}}),()=>{var C,S,y,M;let d={open:e.comboboxState.value===0},b={"aria-activedescendant":e.activeOptionIndex.value===null||(C=e.options.value[e.activeOptionIndex.value])==null?void 0:C.id,"aria-labelledby":(M=(S=h(e.labelRef))==null?void 0:S.id)!=null?M:(y=h(e.buttonRef))==null?void 0:y.id,id:t,ref:e.optionsRef,role:"listbox"},m=W(n,["hold"]);return j({ourProps:b,theirProps:m,slot:d,attrs:O,slots:r,features:K.RenderStrategy|K.Static,visible:R.value,name:"ComboboxOptions"})}}}),$e=F({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(n,{slots:O,attrs:r,expose:T}){let e=B("ComboboxOption"),t=`headlessui-combobox-option-${N()}`,s=w(null);T({el:s,$el:s});let R=x(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),d=x(()=>k(e.mode.value,{[0]:()=>e.compare(v(e.value.value),v(n.value)),[1]:()=>v(e.value.value).some(o=>e.compare(v(o),v(n.value)))})),b=x(()=>({disabled:n.disabled,value:n.value,domRef:s}));$(()=>e.registerOption(t,b)),Y(()=>e.unregisterOption(t)),U(()=>{e.comboboxState.value===0&&(!R.value||e.activationTrigger.value!==0&&L(()=>{var o,c;return(c=(o=h(s))==null?void 0:o.scrollIntoView)==null?void 0:c.call(o,{block:"nearest"})}))});function m(o){if(n.disabled)return o.preventDefault();e.selectOption(t),e.mode.value===0&&e.closeCombobox()}function C(){if(n.disabled)return e.goToOption(g.Nothing);e.goToOption(g.Specific,t)}let S=pe();function y(o){S.update(o)}function M(o){!S.wasMoved(o)||n.disabled||R.value||e.goToOption(g.Specific,t,0)}function D(o){!S.wasMoved(o)||n.disabled||!R.value||e.optionsPropsRef.value.hold||e.goToOption(g.Nothing)}return()=>{let{disabled:o}=n,c={active:R.value,selected:d.value,disabled:o},I={id:t,ref:s,role:"option",tabIndex:o===!0?void 0:-1,"aria-disabled":o===!0?!0:void 0,"aria-selected":d.value,disabled:void 0,onClick:m,onFocus:C,onPointerenter:y,onMouseenter:y,onPointermove:M,onMousemove:M,onPointerleave:D,onMouseleave:D};return j({ourProps:I,theirProps:n,slot:c,attrs:r,slots:O,name:"ComboboxOption"})}}});export{je as Combobox,He as ComboboxButton,Ne as ComboboxInput,Be as ComboboxLabel,$e as ComboboxOption,Ke as ComboboxOptions};
