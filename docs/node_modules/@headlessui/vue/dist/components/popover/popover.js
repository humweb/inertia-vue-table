import{Fragment as Q,computed as O,defineComponent as L,h as H,inject as V,provide as _,ref as T,shallowRef as ae,watchEffect as U,onMounted as X,onUnmounted as Y}from"vue";import{match as K}from'../../utils/match.js';import{render as $,Features as G}from'../../utils/render.js';import{useId as M}from'../../hooks/use-id.js';import{Keys as F}from'../../keyboard.js';import{getFocusableElements as Z,Focus as R,focusIn as x,isFocusableElement as ue,FocusableMode as ie}from'../../utils/focus-management.js';import{dom as l}from'../../utils/dom.js';import{useOpenClosedProvider as se,State as N,useOpenClosed as ee}from'../../internal/open-closed.js';import{useResolveButtonType as pe}from'../../hooks/use-resolve-button-type.js';import{useOutsideClick as fe}from'../../hooks/use-outside-click.js';import{getOwnerDocument as W}from'../../utils/owner.js';import{useEventListener as ve}from'../../hooks/use-event-listener.js';import{Hidden as q,Features as z}from'../../internal/hidden.js';import{useTabDirection as te,Direction as k}from'../../hooks/use-tab-direction.js';import'../../utils/micro-task.js';var ce=(p=>(p[p.Open=0]="Open",p[p.Closed=1]="Closed",p))(ce||{});let oe=Symbol("PopoverContext");function A(c){let m=V(oe,null);if(m===null){let p=new Error(`<${c} /> is missing a parent <${Pe.name} /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(p,A),p}return m}let ne=Symbol("PopoverGroupContext");function le(){return V(ne,null)}let re=Symbol("PopoverPanelContext");function de(){return V(re,null)}let Pe=L({name:"Popover",props:{as:{type:[Object,String],default:"div"}},setup(c,{slots:m,attrs:p,expose:y}){var n;let o=T(null);y({el:o,$el:o});let e=T(1),f=T(null),d=T(null),I=T(null),s=T(null),b=O(()=>W(o)),P=O(()=>{var h,w;if(!l(f)||!l(s))return!1;for(let C of document.querySelectorAll("body > *"))if(Number(C==null?void 0:C.contains(l(f)))^Number(C==null?void 0:C.contains(l(s))))return!0;let t=Z(),r=t.indexOf(l(f)),u=(r+t.length-1)%t.length,v=(r+1)%t.length,S=t[u],j=t[v];return!((h=l(s))!=null&&h.contains(S))&&!((w=l(s))!=null&&w.contains(j))}),a={popoverState:e,buttonId:T(null),panelId:T(null),panel:s,button:f,isPortalled:P,beforePanelSentinel:d,afterPanelSentinel:I,togglePopover(){e.value=K(e.value,{[0]:1,[1]:0})},closePopover(){e.value!==1&&(e.value=1)},close(t){a.closePopover();let r=(()=>t?t instanceof HTMLElement?t:t.value instanceof HTMLElement?l(t):l(a.button):l(a.button))();r==null||r.focus()}};_(oe,a),se(O(()=>K(e.value,{[0]:N.Open,[1]:N.Closed})));let D={buttonId:a.buttonId,panelId:a.panelId,close(){a.closePopover()}},g=le(),E=g==null?void 0:g.registerPopover;function i(){var t,r,u,v;return(v=g==null?void 0:g.isFocusWithinPopoverGroup())!=null?v:((t=b.value)==null?void 0:t.activeElement)&&(((r=l(f))==null?void 0:r.contains(b.value.activeElement))||((u=l(s))==null?void 0:u.contains(b.value.activeElement)))}return U(()=>E==null?void 0:E(D)),ve((n=b.value)==null?void 0:n.defaultView,"focus",t=>{var r,u;e.value===0&&(i()||!f||!s||t.target!==window&&((r=l(a.beforePanelSentinel))!=null&&r.contains(t.target)||(u=l(a.afterPanelSentinel))!=null&&u.contains(t.target)||a.closePopover()))},!0),fe([f,s],(t,r)=>{var u;a.closePopover(),ue(r,ie.Loose)||(t.preventDefault(),(u=l(f))==null||u.focus())},O(()=>e.value===0)),()=>{let t={open:e.value===0,close:a.close};return $({theirProps:c,ourProps:{ref:o},slot:t,slots:m,attrs:p,name:"Popover"})}}}),Be=L({name:"PopoverButton",props:{as:{type:[Object,String],default:"button"},disabled:{type:[Boolean],default:!1},id:{type:String,default:()=>`headlessui-popover-button-${M()}`}},inheritAttrs:!1,setup(c,{attrs:m,slots:p,expose:y}){let o=A("PopoverButton"),e=O(()=>W(o.button));y({el:o.button,$el:o.button}),X(()=>{o.buttonId.value=c.id}),Y(()=>{o.buttonId.value=null});let f=le(),d=f==null?void 0:f.closeOthers,I=de(),s=O(()=>I===null?!1:I.value===o.panelId.value),b=T(null),P=`headlessui-focus-sentinel-${M()}`;s.value||U(()=>{o.button.value=b.value});let a=pe(O(()=>({as:c.as,type:m.type})),b);function D(n){var t,r,u,v,S;if(s.value){if(o.popoverState.value===1)return;switch(n.key){case F.Space:case F.Enter:n.preventDefault(),(r=(t=n.target).click)==null||r.call(t),o.closePopover(),(u=l(o.button))==null||u.focus();break}}else switch(n.key){case F.Space:case F.Enter:n.preventDefault(),n.stopPropagation(),o.popoverState.value===1&&(d==null||d(o.buttonId.value)),o.togglePopover();break;case F.Escape:if(o.popoverState.value!==0)return d==null?void 0:d(o.buttonId.value);if(!l(o.button)||((v=e.value)==null?void 0:v.activeElement)&&!((S=l(o.button))!=null&&S.contains(e.value.activeElement)))return;n.preventDefault(),n.stopPropagation(),o.closePopover();break}}function g(n){s.value||n.key===F.Space&&n.preventDefault()}function E(n){var t,r;c.disabled||(s.value?(o.closePopover(),(t=l(o.button))==null||t.focus()):(n.preventDefault(),n.stopPropagation(),o.popoverState.value===1&&(d==null||d(o.buttonId.value)),o.togglePopover(),(r=l(o.button))==null||r.focus()))}function i(n){n.preventDefault(),n.stopPropagation()}return()=>{let n=o.popoverState.value===0,t={open:n},{id:r,...u}=c,v=s.value?{ref:b,type:a.value,onKeydown:D,onClick:E}:{ref:b,id:r,type:a.value,"aria-expanded":c.disabled?void 0:o.popoverState.value===0,"aria-controls":l(o.panel)?o.panelId.value:void 0,disabled:c.disabled?!0:void 0,onKeydown:D,onKeyup:g,onClick:E,onMousedown:i},S=te();function j(){let h=l(o.panel);if(!h)return;function w(){K(S.value,{[k.Forwards]:()=>x(h,R.First),[k.Backwards]:()=>x(h,R.Last)})}w()}return H(Q,[$({ourProps:v,theirProps:{...m,...u},slot:t,attrs:m,slots:p,name:"PopoverButton"}),n&&!s.value&&o.isPortalled.value&&H(q,{id:P,features:z.Focusable,as:"button",type:"button",onFocus:j})])}}}),Le=L({name:"PopoverOverlay",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0}},setup(c,{attrs:m,slots:p}){let y=A("PopoverOverlay"),o=`headlessui-popover-overlay-${M()}`,e=ee(),f=O(()=>e!==null?e.value===N.Open:y.popoverState.value===0);function d(){y.closePopover()}return()=>{let I={open:y.popoverState.value===0};return $({ourProps:{id:o,"aria-hidden":!0,onClick:d},theirProps:c,slot:I,attrs:m,slots:p,features:G.RenderStrategy|G.Static,visible:f.value,name:"PopoverOverlay"})}}}),He=L({name:"PopoverPanel",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},focus:{type:Boolean,default:!1},id:{type:String,default:()=>`headlessui-popover-panel-${M()}`}},inheritAttrs:!1,setup(c,{attrs:m,slots:p,expose:y}){let{focus:o}=c,e=A("PopoverPanel"),f=O(()=>W(e.panel)),d=`headlessui-focus-sentinel-before-${M()}`,I=`headlessui-focus-sentinel-after-${M()}`;y({el:e.panel,$el:e.panel}),X(()=>{e.panelId.value=c.id}),Y(()=>{e.panelId.value=null}),_(re,e.panelId),U(()=>{var n,t;if(!o||e.popoverState.value!==0||!e.panel)return;let i=(n=f.value)==null?void 0:n.activeElement;(t=l(e.panel))!=null&&t.contains(i)||x(l(e.panel),R.First)});let s=ee(),b=O(()=>s!==null?s.value===N.Open:e.popoverState.value===0);function P(i){var n,t;switch(i.key){case F.Escape:if(e.popoverState.value!==0||!l(e.panel)||f.value&&!((n=l(e.panel))!=null&&n.contains(f.value.activeElement)))return;i.preventDefault(),i.stopPropagation(),e.closePopover(),(t=l(e.button))==null||t.focus();break}}function a(i){var t,r,u,v,S;let n=i.relatedTarget;!n||!l(e.panel)||(t=l(e.panel))!=null&&t.contains(n)||(e.closePopover(),(((u=(r=l(e.beforePanelSentinel))==null?void 0:r.contains)==null?void 0:u.call(r,n))||((S=(v=l(e.afterPanelSentinel))==null?void 0:v.contains)==null?void 0:S.call(v,n)))&&n.focus({preventScroll:!0}))}let D=te();function g(){let i=l(e.panel);if(!i)return;function n(){K(D.value,{[k.Forwards]:()=>{x(i,R.Next)},[k.Backwards]:()=>{var t;(t=l(e.button))==null||t.focus({preventScroll:!0})}})}n()}function E(){let i=l(e.panel);if(!i)return;function n(){K(D.value,{[k.Forwards]:()=>{var w,C;let t=l(e.button),r=l(e.panel);if(!t)return;let u=Z(),v=u.indexOf(t),S=u.slice(0,v+1),h=[...u.slice(v+1),...S];for(let B of h.slice())if(((C=(w=B==null?void 0:B.id)==null?void 0:w.startsWith)==null?void 0:C.call(w,"headlessui-focus-sentinel-"))||(r==null?void 0:r.contains(B))){let J=h.indexOf(B);J!==-1&&h.splice(J,1)}x(h,R.First,{sorted:!1})},[k.Backwards]:()=>x(i,R.Previous)})}n()}return()=>{let i={open:e.popoverState.value===0,close:e.close},{id:n,focus:t,...r}=c,u={ref:e.panel,id:n,onKeydown:P,onFocusout:o&&e.popoverState.value===0?a:void 0,tabIndex:-1};return $({ourProps:u,theirProps:{...m,...r},attrs:m,slot:i,slots:{...p,default:(...v)=>{var S;return[H(Q,[b.value&&e.isPortalled.value&&H(q,{id:d,ref:e.beforePanelSentinel,features:z.Focusable,as:"button",type:"button",onFocus:g}),(S=p.default)==null?void 0:S.call(p,...v),b.value&&e.isPortalled.value&&H(q,{id:I,ref:e.afterPanelSentinel,features:z.Focusable,as:"button",type:"button",onFocus:E})])]}},features:G.RenderStrategy|G.Static,visible:b.value,name:"PopoverPanel"})}}}),Ke=L({name:"PopoverGroup",props:{as:{type:[Object,String],default:"div"}},setup(c,{attrs:m,slots:p,expose:y}){let o=T(null),e=ae([]),f=O(()=>W(o));y({el:o,$el:o});function d(P){let a=e.value.indexOf(P);a!==-1&&e.value.splice(a,1)}function I(P){return e.value.push(P),()=>{d(P)}}function s(){var D;let P=f.value;if(!P)return!1;let a=P.activeElement;return(D=l(o))!=null&&D.contains(a)?!0:e.value.some(g=>{var E,i;return((E=P.getElementById(g.buttonId.value))==null?void 0:E.contains(a))||((i=P.getElementById(g.panelId.value))==null?void 0:i.contains(a))})}function b(P){for(let a of e.value)a.buttonId.value!==P&&a.close()}return _(ne,{registerPopover:I,unregisterPopover:d,isFocusWithinPopoverGroup:s,closeOthers:b}),()=>$({ourProps:{ref:o},theirProps:c,slot:{},attrs:m,slots:p,name:"PopoverGroup"})}});export{Pe as Popover,Be as PopoverButton,Ke as PopoverGroup,Le as PopoverOverlay,He as PopoverPanel};
